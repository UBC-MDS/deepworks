# From Ilya's Lecture 5
# Example 4b: AI Code Critic PR (GitHub Models)
name: AI Critic (PR)

on:
  workflow_dispatch:
  pull_request:
   paths:
     - 'src/**/*.py' # Only run on python source changes

permissions:
  models: read
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for diff

      - name: Get PR Diff
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          # specific to the files we care about, limiting context size
          DIFF=$(git diff origin/${{ github.base_ref }} HEAD src/ | head -n 1000)
          
          # Using heredoc for multiline output safety
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "diff<<$EOF" >> "$GITHUB_OUTPUT"
          echo "$DIFF" >> "$GITHUB_OUTPUT"
          echo "$EOF" >> "$GITHUB_OUTPUT"

      - name: Ask AI critic
        id: ai-response
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          DIFF_CONTENT: ${{ steps.diff.outputs.diff }}
        run: |
          # Create the request payload
          PAYLOAD=$(jq -n \
            --arg diff "$DIFF_CONTENT" \
            '{
              "systemInstruction": {
                "parts": [{
                  "text": "You are a helpful code review assistant for this repository. Your task is to review pull request code changes for quality, correctness, and maintainability.\n\nIf the code is well-written, efficient, and follows best practices, acknowledge the good work and highlight what was done well.\n\nIf the code has issues—such as bugs, inefficiencies, poor readability, or missing tests—provide constructive feedback with specific suggestions for improvement. Explain why the change would help.\n\nBe respectful and supportive—remember that code review is a learning opportunity for everyone involved.\n\nFocus on meaningful improvements rather than nitpicking style preferences.\nAlways respond with ready-to-use markdown content."
                }]
              },
              "contents": [{
                "parts": [{
                  "text": ("Code Changes:\n\n```diff\n" + $diff + "\n```")
                }]
              }],
              "generationConfig": {
                "maxOutputTokens": 1000
              }
            }')

          # Call Gemini API
          RESPONSE=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=$GEMINI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          # Extract the response text
          RESULT=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "Error: Could not get AI response"')

          # Output using heredoc for multiline safety
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "response<<$EOF" >> "$GITHUB_OUTPUT"
          echo "$RESULT" >> "$GITHUB_OUTPUT"
          echo "$EOF" >> "$GITHUB_OUTPUT"

      - name: Comment results on the PR
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.ai-response.outputs.response }}
